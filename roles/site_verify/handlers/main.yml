---
# Handlers for Drupal site ownership and settings file permissions plus Apache reloads.

- name: Enforce Drupal site ownership
  ansible.builtin.command: >
    {{ script_install_dir | default('/usr/local/bin') }}/site-ownership.sh
    --root="{{ site_context_platform_root }}/web/sites/{{ site_context_site_subdir | default(site_context_site_name) }}"
    --user="{{ site_context_platform_user }}"
    --group="{{ apache_group | default('www-data') }}"
  args:
    chdir: "{{ site_context_platform_root }}"
  become: true

- name: Enforce Drupal site permissions
  ansible.builtin.command: >
    {{ script_install_dir | default('/usr/local/bin') }}/site-permissions.sh
    --root="{{ site_context_platform_root }}/web/sites/{{ site_context_site_subdir | default(site_context_site_name) }}"
    --user="{{ site_context_platform_user }}"
    --group="{{ apache_group | default('www-data') }}"
  args:
    chdir: "{{ site_context_platform_root }}"
  become: true

- name: Reload Apache service
  ansible.builtin.service:
    name: "{{ apache_service_name | default('apache2') }}"
    state: reloaded
  become: true

- name: Restart fail2ban
  ansible.builtin.service:
    name: fail2ban
    state: restarted
  become: true
