- name: Check if site directory exists
  ansible.builtin.stat:
    path: "{{ site_context_site_path }}"
  become: true
  register: site_verify_site_dir

- block:
    - name: Set permissions context facts
      ansible.builtin.set_fact:
        site_verify_site_name: "{{ site_context_site_name }}"
        site_verify_site_subdir: "{{ site_context_site_subdir | default(site_context_site_name) }}"
        site_verify_platform_path: "{{ site_context_platform_root }}"
        site_verify_platform_user: "{{ site_context_platform_user }}"
        site_verify_platform_group: "{{ site_context_platform_group }}"

    - name: Enforce Drupal site permissions
      vars:
        site_name: "{{ site_verify_site_name }}"
        site_subdir: "{{ site_verify_site_subdir }}"
        platform_path: "{{ site_verify_platform_path }}"
        platform_user: "{{ site_verify_platform_user }}"
        platform_group: "{{ site_verify_platform_group }}"
      block:
        - name: Ensure site ownership is correct
          ansible.builtin.command: >
            {{ script_install_dir | default('/usr/local/bin') }}/site-ownership.sh
            --root="{{ platform_path }}/web/sites/{{ site_subdir }}"
            --user="{{ platform_user }}"
            --group="{{ apache_group | default('www-data') }}"
          args:
            chdir: "{{ platform_path }}"
          become: true

        - name: Ensure site permissions are correct
          ansible.builtin.command: >
            {{ script_install_dir | default('/usr/local/bin') }}/site-permissions.sh
            --root="{{ platform_path }}/web/sites/{{ site_subdir }}"
            --user="{{ platform_user }}"
            --group="{{ apache_group | default('www-data') }}"
          args:
            chdir: "{{ platform_path }}"
          become: true

        - name: Ensure settings.php is temporarily writable
          ansible.builtin.file:
            path: "{{ platform_path }}/web/sites/{{ site_subdir }}/settings.php"
            mode: "0640"

        - name: Add trusted host patterns
          ansible.builtin.lineinfile:
            path: "{{ platform_path }}/web/sites/{{ site_subdir }}/settings.php"
            regexp: "^# \\$settings\\['trusted_host_patterns'\\] = \\[\\];$"
            line: |
              $settings['trusted_host_patterns'] = [
                '^{{ site_name }}$',
              ];
            state: present

        - name: Restore strict permissions on settings.php
          ansible.builtin.file:
            path: "{{ platform_path }}/web/sites/{{ site_name }}/settings.php"
            mode: "0440"
  when:
    - site_context_should_process | default(false)
    - site_verify_site_dir.stat.exists | default(false)
