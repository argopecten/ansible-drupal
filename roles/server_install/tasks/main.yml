# === Clean up APT configuration ===

- name: Clean non-Ubuntu APT source list files
  block:
    - name: Find APT source list files
      ansible.builtin.find:
        paths: /etc/apt/sources.list.d
        patterns: "*.list"
        file_type: file
      register: apt_list_files
      become: true

    - name: Remove non-Ubuntu source list files
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ apt_list_files.files }}"
      when: >
        ('ubuntu' not in item.path and
         'canonical' not in item.path)
      become: true

- name: Clean non-Ubuntu APT keyrings
  block:
    - name: Find GPG keyring files
      ansible.builtin.find:
        paths: /etc/apt/trusted.gpg.d
        patterns: "*.gpg"
        file_type: file
      register: trusted_keyrings
      become: true

    - name: Remove non-Ubuntu GPG keyrings
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ trusted_keyrings.files }}"
      when: "'ubuntu-keyring' not in item.path"
      become: true

- name: Remove legacy trusted.gpg keyring
  ansible.builtin.file:
    path: /etc/apt/trusted.gpg
    state: absent
  become: true

- name: Clear and update APT cache
  ansible.builtin.shell: |
    rm -rf /var/lib/apt/lists/*
    apt-get update
  args:
    executable: /bin/bash
  become: true

# === Add and configure repositories ===

- name: Add additional repositories
  ansible.builtin.apt_repository:
    repo: "{{ item.repo }}"
    state: present
    update_cache: false
  loop: "{{ additional_repositories }}"
  when: additional_repositories is defined
  become: true

- name: Update apt cache after adding repositories
  ansible.builtin.apt:
    update_cache: true
  register: apt_update_result
  retries: 5
  delay: 5
  until: apt_update_result is succeeded
  when: additional_repositories is defined
  become: true

# === Package installation ===

- name: Install common packages
  ansible.builtin.apt:
    name: "{{ common_packages }}"
    state: present
    update_cache: true
  when: common_packages is defined
  become: true

- name: Install ansible-lint (control hosts only)
  ansible.builtin.apt:
    name: ansible-lint
    state: present
    update_cache: true
  when: "'control' in group_names"
  become: true

- name: Install Apache packages
  ansible.builtin.apt:
    name: "{{ apache_packages | default(['apache2']) }}"
    state: present
    update_cache: true
  when: apache_packages is defined
  become: true

- name: Install MySQL packages
  ansible.builtin.apt:
    name: "{{ mysql_packages }}"
    state: present
    update_cache: true
  when: mysql_packages is defined
  become: true

- name: Install security hardening packages
  ansible.builtin.apt:
    name: "{{ secured_packages }}"
    state: present
    update_cache: true
  when: secured_packages is defined
  become: true
