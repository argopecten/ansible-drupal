# Setup tasks for Apache webserver

# Copy Apache configurations.
- name: Copy Apache configuration files
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    force: true
    owner: "{{ root_user | default('root') }}"
    group: "{{ root_group | default('root') }}"
    mode: '0644'
  loop:
    - { src: "apache-main.conf.j2", dest: "{{ apache_main_conf_file | default('/etc/apache2/apache2.conf') }}" }
    - { src: "apache-drupal.conf.j2", dest: "{{ apache_conf_dir | default('/etc/apache2') }}/conf-available/drupal.conf" }
    - { src: "apache-php-fpm.conf.j2", dest: "{{ apache_conf_dir | default('/etc/apache2') }}/conf-available/php{{ php_version | default('8.3') }}-fpm.conf" }
    - { src: "apache-security.conf.j2", dest: "{{ apache_conf_dir | default('/etc/apache2') }}/conf-available/security.conf" }
    - { src: "apache-vhost-access-log.conf.j2", dest: "{{ apache_conf_dir | default('/etc/apache2') }}/conf-available/vhost-access-log.conf" }
    - { src: "apache-default.conf.j2", dest: "{{ apache_default_site_config | default('/etc/apache2/sites-enabled/default-ssl.conf') }}" }
  notify: Reload Apache

- name: Enable required Apache modules
  ansible.builtin.command: "a2enmod {{ item }}"
  args:
    creates: "{{ apache_conf_dir | default('/etc/apache2') }}/mods-enabled/{{ item }}.load"
  loop:
    - headers
    - ssl
    - proxy
    - proxy_fcgi
    - rewrite
    - actions
  notify: Reload Apache

- name: Enable Apache configuration
  ansible.builtin.command: "a2enconf {{ item.name }}"
  args:
    creates: "{{ apache_conf_dir | default('/etc/apache2') }}/conf-enabled/{{ item.path }}"
  loop:
    - { name: "security", path: "security.conf" }
    - { name: "php{{ php_version | default('8.3') }}-fpm", path: "php{{ php_version | default('8.3') }}-fpm.conf" }
    - { name: "drupal", path: "drupal.conf" }
    - { name: "vhost-access-log", path: "vhost-access-log.conf" }
  loop_control:
    label: "{{ item.name }}"
  notify: Reload Apache

- name: Enable default site
  ansible.builtin.command: a2ensite 000-default
  args:
    creates: "{{ apache_sites_enabled | default('/etc/apache2/sites-enabled') }}/000-default.conf"
  notify: Reload Apache
