---
# Ensures runtime services and helper scripts remain configured properly.

- import_tasks: scripts.yml

- name: Ensure data volume root exists and is traversable
  ansible.builtin.file:
    path: "{{ data_volume_root | regex_replace('/+$', '') }}"
    state: directory
    owner: "{{ ansible_user | default('ansible') }}"
    group: "{{ ansible_user | default('ansible') }}"
    mode: "0755"
  become: true
  when: data_volume_root | default('') | length > 0

- name: Ensure SSH users exist
  ansible.builtin.user:
    name: "{{ item }}"
    shell: /bin/bash
    groups: sudo
    append: true
    state: present
    create_home: true
  loop: "{{ ssh_users | default([]) | reject('equalto', '') | unique | list }}"
  when: ssh_users | default([]) | length > 0
  become: true

- name: Allow passwordless sudo for SSH users
  ansible.builtin.copy:
    dest: /etc/sudoers.d/90-ssh-users
    owner: root
    group: root
    mode: "0440"
    content: |
      {% for user in ssh_users | default([]) | reject('equalto', '') | unique | list %}
      {{ user }} ALL=(ALL) NOPASSWD:ALL
      {% endfor %}
    validate: "visudo -cf %s"
  when: ssh_users | default([]) | length > 0
  become: true

- name: Apply security hardening for secured hosts
  ansible.builtin.import_role:
    name: server_secure
  when:
    - host_secured | default(false)

- name: Apply MySQL configuration
  ansible.builtin.import_role:
    name: os_mysql

- name: Apply Apache configuration
  ansible.builtin.import_role:
    name: os_apache

- name: Apply PHP configuration
  ansible.builtin.import_role:
    name: os_php
