---
# Validates platform ownership/permissions and supporting directories.

- name: Verify Drupal platform "{{ platform_selected.key }}"
  vars:
    platform_root: "{{ platform_base_dir.path ~ '/' ~ platform_selected.value.name }}"
    platform_backup_dir: >-
      {{
        '/home/' ~ platform_selected.value.user ~ '/backup/' ~ platform_selected.key
        if platform_selected.value.user is defined
        else ''
      }}
  block:
    - name: Report platform metadata
      ansible.builtin.debug:
        msg:
          - "Platform: {{ platform_selected.key }}"
          - "Version: {{ platform_selected.value.version | default('n/a') }}"
          - "Path: {{ platform_root }}"

    - name: Ensure platform base directory exists
      ansible.builtin.file:
        path: "{{ platform_base_dir.path }}"
        state: directory
        owner: "{{ platform_base_dir.owner }}"
        group: "{{ platform_base_dir.group }}"
        mode: "{{ platform_base_dir.mode }}"
      become: true

    - name: Check if platform root exists
      ansible.builtin.stat:
        path: "{{ platform_root }}"
      register: platform_root_stat

    - name: Warn when platform root is missing
      ansible.builtin.debug:
        msg: "Platform root does not exist for {{ platform_selected.key }} on host {{ inventory_hostname }}"
      when: not platform_root_stat.stat.exists

    - name: Verify Apache user is member of platform group
      ansible.builtin.command:
        cmd: "id -nG {{ apache_group | default('www-data') }}"
      register: apache_groups_result
      changed_when: false
      become: true
      when: platform_root_stat.stat.exists

    - name: Assert Apache user has platform group membership
      ansible.builtin.assert:
        that:
          - "platform_selected.value.group in apache_groups_result.stdout.split()"
        fail_msg: >-
          Apache user {{ apache_group | default('www-data') }} is not a member of platform group {{ platform_selected.value.group }}.
          This will cause permission issues when Apache tries to access platform code.
          Run platform_context tasks to add Apache to the platform group.
        success_msg: >-
          Verified: Apache user {{ apache_group | default('www-data') }} is a member of platform group {{ platform_selected.value.group }}.
      when:
        - platform_root_stat.stat.exists
        - apache_groups_result is defined

    - name: Ensure platform root has correct ownership
      ansible.builtin.file:
        path: "{{ platform_root }}"
        state: directory
        owner: "{{ platform_selected.value.user }}"
        group: "{{ platform_selected.value.group }}"
        mode: "{{ platform_selected.value.drupal_root_permissions | default(drupal_root_permissions | default('0750')) }}"
      become: true
      changed_when: true
      notify:
        - Enforce Drupal platform ownership
        - Enforce Drupal platform permissions

    - name: Ensure platform backup directory exists
      ansible.builtin.file:
        path: "{{ platform_backup_dir }}"
        state: directory
        owner: "{{ platform_selected.value.user }}"
        group: "{{ platform_selected.value.group }}"
        mode: "0750"
      become: true
      when:
        - not ansible_check_mode
        - platform_selected.value.user is defined
        - platform_selected.value.group is defined

    - name: Restart PHP-FPM service for platform changes
      ansible.builtin.service:
        name: "{{ php_fpm_service_name | default('php' ~ (php_version | default('8.3')) ~ '-fpm') }}"
        state: restarted
      become: true
      when:
        - not ansible_check_mode
  when:
    - platform_selected is defined
    - (platform_selected.value.state | default('present')) != 'absent'
