---
# Setup tasks for MySQL server

- name: Install MySQL packages
  ansible.builtin.apt:
    name: "{{ mysql_packages }}"
    state: present
    update_cache: yes
  become: true

# Copy MySQL configurations.
- name: Copy MySQL global configuration
  ansible.builtin.template:
    src: "mysql-global.conf.j2"
    dest: /etc/mysql/mysql.cnf
    owner: "{{ root_user }}"
    group: "{{ root_group }}"
    mode: "0644"
    force: true
  notify: Restart MySQL
  become: true

- name: Copy MySQL server configuration
  ansible.builtin.template:
    src: "mysql-server.conf.j2"
    dest: /etc/mysql/mysql.conf.d/mysqld.cnf
    owner: "{{ root_user }}"
    group: "{{ root_group }}"
    mode: "0644"
    force: true
  notify: Restart MySQL
  become: true

- name: Copy MySQL client configuration
  ansible.builtin.template:
    src: "mysql-client.conf.j2"
    dest: /etc/mysql/mysql.conf.d/client.cnf
    owner: "{{ root_user }}"
    group: "{{ root_group }}"
    mode: "0644"
    force: true
  notify: Restart MySQL
  become: true

# --------------------------------------------
# ðŸ”§ Custom MySQL Data Directory (Conditional and Validated)
# --------------------------------------------
- name: Setup custom MySQL data directory
  block:

    - name: Check if custom MySQL data directory exists
      ansible.builtin.stat:
        path: "{{ mysql_data_dir }}"
      register: mysql_data_dir_stat
      become: true

    - name: Create custom MySQL data directory (if it doesn't exist)
      ansible.builtin.file:
        path: "{{ mysql_data_dir }}"
        state: directory
        owner: mysql
        group: mysql
        mode: '0750'
      become: true
      when: not mysql_data_dir_stat.stat.exists

    - name: Check if MySQL system data already exists (via db.opt)
      ansible.builtin.stat:
        path: "{{ mysql_data_dir }}/mysql/db.opt"
      register: mysql_system_db_opt_stat
      become: true

    - name: Copy existing MySQL data to new directory (only if not initialized)
      ansible.builtin.command: >
        rsync -avzh /var/lib/mysql/ {{ mysql_data_dir }}/
      become: true
      when:
        - not mysql_system_db_opt_stat.stat.exists

    - name: Update AppArmor for MySQL custom data directory
      ansible.builtin.blockinfile:
        path: /etc/apparmor.d/usr.sbin.mysqld
        marker: "# {mark} ANSIBLE MANAGED BLOCK - Custom MySQL Datadir"
        block: "{{ lookup('template', 'apparmor-mysql-custom-datadir.j2') }}"
        insertbefore: '^\}'
      notify: Reload AppArmor

  when: mysql_data_dir != "/var/lib/mysql"

# --------------------------------------------

- name: Ensure MySQL is running
  ansible.builtin.service:
    name: mysql
    state: started
    enabled: true
  become: true
