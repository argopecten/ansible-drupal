---
# Setup tasks for MySQL server

- name: Install MySQL packages
  ansible.builtin.apt:
    name: "{{ mysql_packages }}"
    state: present
    update_cache: yes
  become: true

# Copy MySQL configurations.
- name: Copy MySQL global configuration
  ansible.builtin.template:
    src: "mysql-global.conf.j2"
    dest: /etc/mysql/mysql.cnf
    owner: "{{ root_user }}"
    group: "{{ root_group }}"
    mode: "0644"
    force: true
  notify: Restart MySQL
  become: true

- name: Copy MySQL server configuration
  ansible.builtin.template:
    src: "mysql-server.conf.j2"
    dest: /etc/mysql/mysql.conf.d/mysqld.cnf
    owner: "{{ root_user }}"
    group: "{{ root_group }}"
    mode: "0644"
    force: true
  notify: Restart MySQL
  become: true

- name: Copy MySQL client configuration
  ansible.builtin.template:
    src: "mysql-client.conf.j2"
    dest: /etc/mysql/mysql.conf.d/client.cnf
    owner: "{{ root_user }}"
    group: "{{ root_group }}"
    mode: "0644"
    force: true
  notify: Restart MySQL
  become: true

# --------------------------------------------
# ðŸ”§ Custom MySQL Data Directory (Conditional and Validated)
# --------------------------------------------
- name: Setup custom MySQL data directory
  block:

    - name: Check if custom MySQL data directory exists
      ansible.builtin.stat:
        path: "{{ mysql_data_dir }}"
      register: mysql_data_dir_stat
      become: true

    - name: Create custom MySQL data directory (if it doesn't exist)
      ansible.builtin.file:
        path: "{{ mysql_data_dir }}"
        state: directory
        owner: mysql
        group: mysql
        mode: '0750'
      become: true
      when: not mysql_data_dir_stat.stat.exists

    - name: Check if MySQL system data already exists (via db.opt)
      ansible.builtin.stat:
        path: "{{ mysql_data_dir }}/mysql/db.opt"
      register: mysql_system_db_opt_stat
      become: true

    - name: Copy existing MySQL data to new directory (only if not initialized)
      ansible.builtin.command: >
        rsync -avzh /var/lib/mysql/ {{ mysql_data_dir }}/
      become: true
      when:
        - not mysql_system_db_opt_stat.stat.exists

  when: mysql_data_dir != "/var/lib/mysql"

# --------------------------------------------

- name: Ensure local AppArmor include is enabled for MySQL
  ansible.builtin.lineinfile:
    path: /etc/apparmor.d/usr.sbin.mysqld
    regexp: '^\\s*#?\\s*include\\s+<local/usr\\.sbin\\.mysqld>'
    line: '#include <local/usr.sbin.mysqld>'
    state: present
  notify: Reload AppArmor
  become: true

- name: Install MySQL AppArmor overrides
  ansible.builtin.template:
    src: "apparmor-mysql-custom-datadir.j2"
    dest: /etc/apparmor.d/local/usr.sbin.mysqld
    owner: root
    group: root
    mode: "0644"
    force: true
  notify: Reload AppArmor
  become: true

- name: Apply AppArmor updates before starting MySQL
  meta: flush_handlers

- name: Ensure MySQL is running
  ansible.builtin.service:
    name: "{{ mysql_service_name | default('mysql') }}"
    state: started
    enabled: true
  become: true

- name: Check MySQL socket availability
  ansible.builtin.stat:
    path: "{{ mysql_unix_socket | default('/run/mysqld/mysqld.sock') }}"
  register: mysql_socket_stat
  become: true

- name: Load timezone data into MySQL
  ansible.builtin.shell: |
    mysql_tzinfo_to_sql /usr/share/zoneinfo | mysql -u root mysql
  args:
    executable: /bin/bash
  become: true
  register: mysql_tzinfo_result
  changed_when: '"Data loaded" not in mysql_tzinfo_result.stdout'
  failed_when: false
  ignore_errors: yes
  when: mysql_socket_stat.stat.exists | default(false)

- name: Verify timezone data is loaded
  community.mysql.mysql_query:
    login_unix_socket: "{{ mysql_unix_socket }}"
    login_db: mysql
    query: "SELECT COUNT(*) as count FROM time_zone_name"
  become: true
  register: mysql_tz_check
  ignore_errors: yes
  when: mysql_socket_stat.stat.exists | default(false)

- name: Log timezone data status
  ansible.builtin.debug:
    msg: "MySQL timezone data: {{ 'loaded (' + (mysql_tz_check.query_result[0][0].count | string) + ' timezones)' if mysql_tz_check.query_result[0][0].count | default(0) > 0 else 'not loaded or needs manual update' }}"
  when: mysql_tz_check.query_result is defined
