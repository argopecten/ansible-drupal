# /etc/apache2/sites-available/{{ site_name }}.conf
# Apache vhost configuration on {{ inventory_hostname }}
# {{ ansible_managed }} at {{ ansible_date_time.date }} {{ ansible_date_time.time }}

{% set site_apex = site_name.split('.')[-2:] | join('.') %}

<VirtualHost *:{{ apache_listen_http_port }}>
    ServerName {{ site_name }}
    
    # Redirect all HTTP traffic to HTTPS
    RewriteEngine On
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

<VirtualHost *:{{ apache_listen_https_port }}>
    ServerName {{ site_name }}
    DocumentRoot {{ platform_path }}/web

    <Directory {{ platform_path }}/web>
        AllowOverride All
        Require all granted
        DirectoryIndex index.php
    </Directory>

    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/{{ site_apex }}.pem
    SSLCertificateKeyFile /etc/ssl/private/{{ site_apex }}.key

    ErrorLog /var/log/apache2/error.log
    CustomLog /var/log/apache2/access.log vhost_combined
</VirtualHost>
