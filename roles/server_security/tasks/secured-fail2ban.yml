---
# Fail2Ban setup for LEMP Stack
- name: Ensure fail2ban is installed
  ansible.builtin.apt:
    name: fail2ban
    state: present
    update_cache: yes
  become: true

# Set up fail2ban-server configuration
- name: Configure fail2ban.local for fail2ban-server
  ansible.builtin.template:
    src: "fail2ban-server.conf.j2"
    dest: /etc/fail2ban/fail2ban.local
    owner: "{{ root_user }}"
    group: "{{ root_group }}"
    mode: '0644'
  notify:
    - Restart fail2ban
  become: true

# Set up fail2ban jail configuration
- name: Configure jail.local
  ansible.builtin.template:
    src: "fail2ban-jail-local.conf.j2"
    dest: /etc/fail2ban/jail.local
    owner: "{{ root_user }}"
    group: "{{ root_group }}"
    mode: '0644'
  notify:
    - Restart fail2ban
  become: true

# Start and enable fail2ban service
- name: Start fail2ban service
  ansible.builtin.service:
    name: fail2ban
    state: started
    enabled: true
  changed_when: false

- name: Check fail2ban status
  command: fail2ban-client status
  register: fail2ban_status
  changed_when: false

- name: Display fail2ban status
  debug:
    var: fail2ban_status.stdout_lines
