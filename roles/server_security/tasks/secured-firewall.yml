---
# UFW Setup for LEMP Stack
- name: Ensure UFW is installed
  ansible.builtin.apt:
    name: ufw
    state: present
    update_cache: yes
  become: true

# Set up UFW default configuration
- name: Configure default configuration for UFW
  ansible.builtin.template:
    src: "ufw-default.conf.j2"
    dest: /etc/default/ufw
    owner: "{{ root_user }}"
    group: "{{ root_group }}"
    mode: '0644'
    force: yes
  notify: Reload UFW
  become: true

# Set up UFW configuration
- name: Configure UFW
  ansible.builtin.template:
    src: "ufw-etc.conf.j2"
    dest: /etc/ufw/ufw.conf
    owner: "{{ root_user }}"
    group: "{{ root_group }}"
    mode: '0644'
    force: yes
  notify: Reload UFW
  become: true

# Set up UFW user rules
- name: Configure user rules for UFW
  ansible.builtin.template:
    src: "ufw-user.conf.j2"
    dest: /etc/ufw/user.rules
    owner: "{{ root_user }}"
    group: "{{ root_group }}"
    mode: '0644'
    force: yes
  notify: Reload UFW
  become: true

# Set up UFW user6 rules
- name: Configure user6 rules for UFW
  ansible.builtin.template:
    src: "ufw-user6.conf.j2"
    dest: /etc/ufw/user6.rules
    owner: "{{ root_user }}"
    group: "{{ root_group }}"
    mode: '0644'
    force: yes
  notify: Reload UFW
  become: true

# Enable UFW
- name: Enable UFW
  ansible.builtin.command: ufw --force enable
  changed_when: false
  become: true
  become_user: "{{ root_user }}"
  when:
    - ufw_enabled is defined and ufw_enabled == "yes"

- name: Check UFW status
  ansible.builtin.command: ufw status verbose
  register: ufw_status
  changed_when: false

- name: Display UFW status
  ansible.builtin.debug:
    var: ufw_status.stdout_lines
