# Creates new Drupal sites on the specified platform/server.

- block:
    - name: Prepare site and platform context
      ansible.builtin.include_role:
        name: site_context
      when: not site_context_cached | default(false)

    - name: Initialize site existence flag
      ansible.builtin.set_fact:
        site_install_site_exists: "{{ site_context_site_exists | default(false) }}"

    - block:
        - name: Install new site
          ansible.builtin.include_tasks: install-site-drush.yml
          when: not site_install_site_exists

        - name: Install CiviCRM
          ansible.builtin.include_tasks: install-civicrm.yml
          when:
            - not site_install_site_exists
            - site_context_civicrm_install | default(false)

        - name: Update site context after installation
          ansible.builtin.set_fact:
            site_context_site_exists: true
          when: not site_install_site_exists

        - name: Create login URL
          ansible.builtin.import_role:
            name: site_login
          when: not site_install_site_exists

        - name: Log message if site already exists
          ansible.builtin.debug:
            msg: "Site {{ site_context_site_name }} already exists."
          when: site_install_site_exists
      when: site_context_should_process

    - name: Verify and finalize site configuration
      ansible.builtin.import_role:
        name: site_verify
      when:
        - site_context_should_process
        - site_context_site_exists | default(false)
